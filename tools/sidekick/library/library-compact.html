<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="Description" content="AEM Block Library" />
  <meta name="robots" content="noindex" />
  <title>Block Library</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      height: 100%;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .library-header {
      padding: 16px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      flex-shrink: 0;
    }

    .library-header h1 {
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .search-box {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      outline: none;
    }

    .search-box:focus {
      border-color: #0066cc;
      box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
    }

    .library-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .library-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: #666;
      margin: 0 8px 8px 8px;
      letter-spacing: 0.5px;
    }

    .block-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .block-item {
      margin: 0;
      padding: 0;
    }

    .block-button {
      width: 100%;
      padding: 12px 16px;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      border-radius: 4px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .block-button:hover {
      background: #f0f0f0;
      color: #0066cc;
    }

    .block-button:active {
      background: #e0e0e0;
    }

    .block-icon {
      width: 24px;
      height: 24px;
      background: #0066cc;
      color: white;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      flex-shrink: 0;
    }

    .block-name {
      flex: 1;
    }

    .status {
      padding: 12px 16px;
      text-align: center;
      color: #666;
      font-size: 13px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fafafa;
      border-top: 1px solid #eee;
    }

    .loading {
      color: #0066cc;
    }

    .error {
      color: #d32f2f;
    }

    /* Scrollbar styling */
    .library-content::-webkit-scrollbar {
      width: 8px;
    }

    .library-content::-webkit-scrollbar-track {
      background: #f5f5f5;
    }

    .library-content::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }

    .library-content::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    .empty-state {
      padding: 32px 16px;
      text-align: center;
      color: #999;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="library-header">
    <h1>üìö Block Library</h1>
    <input 
      type="text" 
      id="search" 
      class="search-box" 
      placeholder="Search blocks..."
      autocomplete="off"
    />
  </div>

  <div class="library-content" id="content">
    <div class="loading">Loading blocks...</div>
  </div>

  <div class="status" id="status">Ready</div>

  <script>
    const LIBRARY_URL = 'https://main--military--jfoxx.aem.page/admin/tools/sidekick/library.json';
    
    const els = {
      search: document.getElementById('search'),
      content: document.getElementById('content'),
      status: document.getElementById('status'),
    };

    let allBlocks = [];
    let allTemplates = [];

    function setStatus(text, type = '') {
      els.status.textContent = text;
      els.status.className = `status ${type}`;
      console.log('[STATUS]', text);
    }

    async function loadLibrary() {
      setStatus('Loading library...', 'loading');
      try {
        const response = await fetch(LIBRARY_URL);
        if (!response.ok) throw new Error(`Failed to load library: ${response.status}`);
        
        const data = await response.json();
        console.log('[LIBRARY DATA]', data);

        // Separate blocks and templates
        allBlocks = data.data.filter(item => item.path.includes('/blocks/'));
        allTemplates = data.data.filter(item => item.path.includes('/templates/'));

        renderLibrary(allBlocks, allTemplates);
        setStatus('Ready');
      } catch (error) {
        console.error('[LOAD ERROR]', error);
        setStatus(`Error: ${error.message}`, 'error');
        els.content.innerHTML = `
          <div class="empty-state">
            ‚ùå Failed to load library<br>
            <small>${error.message}</small>
          </div>
        `;
      }
    }

    function renderLibrary(blocks, templates) {
      els.content.innerHTML = '';

      // Render Blocks section
      if (blocks.length > 0) {
        const blocksSection = document.createElement('div');
        blocksSection.className = 'library-section';
        blocksSection.innerHTML = '<h2 class="section-title">Blocks</h2>';
        
        const blocksList = document.createElement('ul');
        blocksList.className = 'block-list';
        
        blocks.forEach(block => {
          const li = document.createElement('li');
          li.className = 'block-item';
          
          const button = document.createElement('button');
          button.className = 'block-button';
          button.innerHTML = `
            <span class="block-icon">${block.name.charAt(0)}</span>
            <span class="block-name">${block.name}</span>
          `;
          button.addEventListener('click', () => insertBlock(block));
          
          li.appendChild(button);
          blocksList.appendChild(li);
        });
        
        blocksSection.appendChild(blocksList);
        els.content.appendChild(blocksSection);
      }

      // Render Templates section
      if (templates.length > 0) {
        const templatesSection = document.createElement('div');
        templatesSection.className = 'library-section';
        templatesSection.innerHTML = '<h2 class="section-title">Templates</h2>';
        
        const templatesList = document.createElement('ul');
        templatesList.className = 'block-list';
        
        templates.forEach(template => {
          const li = document.createElement('li');
          li.className = 'block-item';
          
          const button = document.createElement('button');
          button.className = 'block-button';
          button.innerHTML = `
            <span class="block-icon">üìÑ</span>
            <span class="block-name">${template.name}</span>
          `;
          button.addEventListener('click', () => insertBlock(template));
          
          li.appendChild(button);
          templatesList.appendChild(li);
        });
        
        templatesSection.appendChild(templatesList);
        els.content.appendChild(templatesSection);
      }

      if (blocks.length === 0 && templates.length === 0) {
        els.content.innerHTML = '<div class="empty-state">No blocks found</div>';
      }
    }

    function filterLibrary(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      
      if (!term) {
        renderLibrary(allBlocks, allTemplates);
        return;
      }

      const filteredBlocks = allBlocks.filter(block => 
        block.name.toLowerCase().includes(term)
      );
      
      const filteredTemplates = allTemplates.filter(template => 
        template.name.toLowerCase().includes(term)
      );

      renderLibrary(filteredBlocks, filteredTemplates);
      
      if (filteredBlocks.length === 0 && filteredTemplates.length === 0) {
        setStatus(`No results for "${searchTerm}"`);
      } else {
        setStatus(`Found ${filteredBlocks.length + filteredTemplates.length} items`);
      }
    }

    async function insertBlock(item) {
      console.log('[INSERT BLOCK]', item);
      setStatus(`Inserting ${item.name}...`, 'loading');

      try {
        // Load the block content from its path
        const response = await fetch(item.path);
        if (!response.ok) throw new Error(`Failed to load block: ${response.status}`);
        
        const html = await response.text();
        console.log('[BLOCK HTML]', html);

        // Create a temporary container to parse the HTML
        const temp = document.createElement('div');
        temp.innerHTML = html;

        // Find the main table that represents the block
        const blockTable = temp.querySelector('table');
        
        if (!blockTable) {
          throw new Error('No block table found in the loaded content');
        }

        // Copy the table to clipboard
        const clipboardItem = new ClipboardItem({
          'text/html': new Blob([blockTable.outerHTML], { type: 'text/html' }),
          'text/plain': new Blob([blockTable.textContent], { type: 'text/plain' })
        });

        await navigator.clipboard.write([clipboardItem]);
        
        setStatus(`‚úÖ ${item.name} copied to clipboard!`);
        
        // Reset after 2 seconds
        setTimeout(() => {
          setStatus('Ready');
        }, 2000);

      } catch (error) {
        console.error('[INSERT ERROR]', error);
        setStatus(`‚ùå Failed: ${error.message}`, 'error');
      }
    }

    // Event listeners
    els.search.addEventListener('input', (e) => {
      filterLibrary(e.target.value);
    });

    els.search.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        els.search.value = '';
        filterLibrary('');
      }
    });

    // Load library on page load
    loadLibrary();

    // Focus search box
    setTimeout(() => {
      els.search.focus();
    }, 100);
  </script>
</body>
</html>

